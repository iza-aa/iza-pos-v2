# ü§ñ DATABASE AI GUIDE - FOODIES POS
**AI Chatbot Context & Reference Guide**
*Last Updated: December 14, 2025*
*Database: PostgreSQL/Supabase*

---

## üìö TABLE OF CONTENTS
1. [Quick Reference](#quick-reference)
2. [Table Schemas](#table-schemas)
3. [Relationships & Foreign Keys](#relationships--foreign-keys)
4. [Triggers & Functions](#triggers--functions)
5. [Business Logic Rules](#business-logic-rules)
6. [Common Query Patterns](#common-query-patterns)
7. [Complex JOIN Examples](#complex-join-examples)
8. [Enum Values & Constants](#enum-values--constants)
9. [Calculated Fields & Formulas](#calculated-fields--formulas)
10. [Indexes & Performance](#indexes--performance)
11. [Error Scenarios](#error-scenarios)
12. [Data Flow Diagrams](#data-flow-diagrams)

---

## üéØ QUICK REFERENCE

### Database Tables (22 Total)
**Authentication & Users:**
- `staff` - Owner, Manager, Staff (barista, kitchen, waiter, cashier)
- `customers` - Customer loyalty & membership

**Menu Management:**
- `categories` - Menu categories (Coffee, Food, etc)
- `products` - Menu items/products
- `variant_groups` - Variant groups (Size, Milk Type, etc)
- `variant_options` - Variant options (Small, Large, Oat Milk, etc)
- `product_variant_groups` - Many-to-many: products ‚Üî variant_groups

**Inventory:**
- `inventory_items` - Raw materials (ingredients, packaging, supplies)
- `recipes` - Product recipes (base, variant-specific, variant-modifier)
- `recipe_ingredients` - Ingredients needed per recipe
- `usage_transactions` - Inventory usage history
- `usage_transaction_details` - Detailed ingredient usage per transaction

**Orders & Sales:**
- `orders` - Customer orders
- `order_items` - Items in each order
- `pos_sessions` - POS cashier sessions
- `payment_transactions` - Payment records
- `tables` - Dine-in table management

**Staff Management:**
- `staff_shifts` - Staff shift schedules
- `presensi_shift` - Staff attendance/presence records
- `presence_code` - Temporary attendance codes

**System:**
- `activity_logs` - Audit trail for all actions
- `archives` - Monthly archive metadata

---

## üìä TABLE SCHEMAS

### 1. STAFF
**Purpose:** Store all system users (owner, manager, staff)
**Primary Key:** `id` (UUID)

| Column | Type | Constraints | Default | Purpose |
|--------|------|-------------|---------|---------|
| id | UUID | PK, NOT NULL | uuid_generate_v4() | Unique identifier |
| staff_code | VARCHAR(20) | UNIQUE, NOT NULL | - | Staff code (e.g., STF001, MGR001) |
| name | VARCHAR(100) | NOT NULL | - | Full name |
| email | VARCHAR(100) | UNIQUE | - | Email (for owner/manager) |
| phone | VARCHAR(20) | - | - | Phone number |
| role | VARCHAR(20) | NOT NULL, CHECK | - | 'owner', 'manager', 'staff' |
| staff_type | VARCHAR(20) | CHECK | - | 'barista', 'kitchen', 'waiter', 'cashier' |
| status | VARCHAR(20) | NOT NULL, CHECK | 'active' | 'active', 'inactive', 'on-leave', 'terminated' |
| password_hash | VARCHAR(255) | - | - | Bcrypt hash (owner/manager) |
| login_code | VARCHAR(8) | - | - | Temporary code for staff |
| login_code_expires_at | TIMESTAMP | - | - | Code expiry (24h) |
| profile_picture | TEXT | - | - | Profile image URL |
| hired_date | DATE | - | CURRENT_DATE | Hiring date |
| created_at | TIMESTAMP | - | NOW() | Record creation |
| updated_at | TIMESTAMP | - | NOW() | Last update |
| created_by | UUID | FK ‚Üí staff.id | - | Who created this record |

**Relationships:**
- Self-reference: `created_by` ‚Üí `staff.id`
- Parent of: orders, products, recipes, activity_logs, etc.

**Business Rules:**
- Owner/Manager: use email + password_hash
- Staff: use staff_code + login_code (expires 24h)
- login_code regenerated by owner/manager

---

### 2. CUSTOMERS
**Purpose:** Customer data & loyalty program
**Primary Key:** `id` (UUID)

| Column | Type | Constraints | Default | Purpose |
|--------|------|-------------|---------|---------|
| id | UUID | PK, NOT NULL | uuid_generate_v4() | Unique identifier |
| phone | VARCHAR(20) | UNIQUE, NOT NULL | - | Phone (login method) |
| name | VARCHAR(100) | NOT NULL | - | Customer name |
| email | VARCHAR(100) | - | - | Email address |
| loyalty_points | INTEGER | - | 0 | Reward points |
| member_since | DATE | - | CURRENT_DATE | Membership start |
| total_spent | NUMERIC | - | 0 | Lifetime spending |
| visit_count | INTEGER | - | 0 | Total visits |
| status | VARCHAR(20) | NOT NULL, CHECK | 'active' | 'active', 'inactive', 'blocked' |
| created_at | TIMESTAMP | - | NOW() | Record creation |
| updated_at | TIMESTAMP | - | NOW() | Last update |

**Relationships:**
- Parent of: orders

**Business Rules:**
- Login via phone number
- loyalty_points accumulated per purchase
- total_spent & visit_count auto-calculated

---

### 3. CATEGORIES
**Purpose:** Menu item categories
**Primary Key:** `id` (UUID)

| Column | Type | Constraints | Default | Purpose |
|--------|------|-------------|---------|---------|
| id | UUID | PK, NOT NULL | uuid_generate_v4() | Unique identifier |
| name | VARCHAR(100) | NOT NULL | - | Category name |
| icon | VARCHAR(50) | - | - | Icon emoji/name |
| sort_order | INTEGER | - | 0 | Display order |
| is_active | BOOLEAN | - | TRUE | Active status |
| type | VARCHAR(20) | - | 'food' | Category type |
| created_at | TIMESTAMP | - | NOW() | Record creation |
| updated_at | TIMESTAMP | - | NOW() | Last update |

**Relationships:**
- Parent of: products

---

### 4. PRODUCTS
**Purpose:** Menu items/products
**Primary Key:** `id` (UUID)

| Column | Type | Constraints | Default | Purpose |
|--------|------|-------------|---------|---------|
| id | UUID | PK, NOT NULL | uuid_generate_v4() | Unique identifier |
| name | VARCHAR(100) | NOT NULL | - | Product name |
| category_id | UUID | FK ‚Üí categories.id | - | Category |
| description | TEXT | - | - | Product description |
| price | NUMERIC | NOT NULL | - | Base price |
| image | TEXT | - | - | Product image URL |
| stock | INTEGER | - | 0 | Stock quantity |
| available | BOOLEAN | - | TRUE | Availability status |
| has_variants | BOOLEAN | - | FALSE | Has variants flag |
| created_at | TIMESTAMP | - | NOW() | Record creation |
| updated_at | TIMESTAMP | - | NOW() | Last update |
| created_by | UUID | FK ‚Üí staff.id | - | Creator |
| updated_by | UUID | FK ‚Üí staff.id | - | Last updater |

**Relationships:**
- Child of: categories (SET NULL on delete)
- Parent of: order_items, recipes, product_variant_groups
- Many-to-many with: variant_groups (via product_variant_groups)

**Trigger:**
- `trigger_log_product_changes` - Logs updates to activity_logs

---

### 5. VARIANT_GROUPS
**Purpose:** Variant group definitions (Size, Milk Type, etc)
**Primary Key:** `id` (UUID)

| Column | Type | Constraints | Default | Purpose |
|--------|------|-------------|---------|---------|
| id | UUID | PK, NOT NULL | uuid_generate_v4() | Unique identifier |
| name | VARCHAR(100) | NOT NULL | - | Group name (e.g., "Size") |
| type | VARCHAR(20) | NOT NULL, CHECK | - | 'single', 'multiple' |
| required | BOOLEAN | - | FALSE | Is selection required |
| is_active | BOOLEAN | - | TRUE | Active status |
| created_at | TIMESTAMP | - | NOW() | Record creation |
| updated_at | TIMESTAMP | - | NOW() | Last update |

**Relationships:**
- Parent of: variant_options
- Many-to-many with: products (via product_variant_groups)

---

### 6. VARIANT_OPTIONS
**Purpose:** Options within variant groups
**Primary Key:** `id` (UUID)

| Column | Type | Constraints | Default | Purpose |
|--------|------|-------------|---------|---------|
| id | UUID | PK, NOT NULL | uuid_generate_v4() | Unique identifier |
| variant_group_id | UUID | FK ‚Üí variant_groups.id | - | Parent group |
| name | VARCHAR(100) | NOT NULL | - | Option name (e.g., "Large") |
| price_modifier | NUMERIC | - | 0 | Price adjustment |
| sort_order | INTEGER | - | 0 | Display order |
| is_active | BOOLEAN | - | TRUE | Active status |
| created_at | TIMESTAMP | - | NOW() | Record creation |
| updated_at | TIMESTAMP | - | NOW() | Last update |

**Relationships:**
- Child of: variant_groups (CASCADE on delete)

---

### 7. PRODUCT_VARIANT_GROUPS
**Purpose:** Many-to-many relationship: products ‚Üî variant_groups
**Primary Key:** `id` (UUID)

| Column | Type | Constraints | Default | Purpose |
|--------|------|-------------|---------|---------|
| id | UUID | PK, NOT NULL | uuid_generate_v4() | Unique identifier |
| product_id | UUID | FK ‚Üí products.id, UNIQUE | - | Product |
| variant_group_id | UUID | FK ‚Üí variant_groups.id, UNIQUE | - | Variant group |
| created_at | TIMESTAMP | - | NOW() | Record creation |

**Relationships:**
- Child of: products (CASCADE on delete)
- Child of: variant_groups (CASCADE on delete)

---

### 8. INVENTORY_ITEMS
**Purpose:** Raw materials (ingredients, packaging, supplies)
**Primary Key:** `id` (UUID)

| Column | Type | Constraints | Default | Purpose |
|--------|------|-------------|---------|---------|
| id | UUID | PK, NOT NULL | uuid_generate_v4() | Unique identifier |
| name | VARCHAR(100) | NOT NULL | - | Item name |
| category | VARCHAR(50) | CHECK | - | 'Ingredients', 'Packaging', 'Supplies' |
| current_stock | NUMERIC | NOT NULL | 0 | Current quantity |
| reorder_level | NUMERIC | NOT NULL | 0 | Minimum stock level |
| unit | VARCHAR(20) | NOT NULL | - | Unit (g, ml, pcs, etc) |
| supplier | VARCHAR(100) | - | - | Supplier name |
| cost_per_unit | NUMERIC | - | 0 | Unit cost |
| last_restocked | DATE | - | - | Last restock date |
| status | VARCHAR(20) | CHECK | 'in-stock' | 'in-stock', 'low-stock', 'out-of-stock' |
| created_at | TIMESTAMP | - | NOW() | Record creation |
| updated_at | TIMESTAMP | - | NOW() | Last update |

**Relationships:**
- Parent of: recipe_ingredients, usage_transaction_details

**Business Rules:**
- status auto-calculated:
  - `out-of-stock`: current_stock <= 0
  - `low-stock`: current_stock <= reorder_level
  - `in-stock`: current_stock > reorder_level

---

### 9. RECIPES
**Purpose:** Product recipes (base, variant-specific, variant-modifier)
**Primary Key:** `id` (UUID)

| Column | Type | Constraints | Default | Purpose |
|--------|------|-------------|---------|---------|
| id | UUID | PK, NOT NULL | uuid_generate_v4() | Unique identifier |
| product_id | UUID | FK ‚Üí products.id | - | Product (NULL for global) |
| product_name | VARCHAR(100) | NOT NULL | - | Product name |
| recipe_type | VARCHAR(20) | NOT NULL, CHECK | - | 'base', 'variant-specific', 'variant-modifier' |
| variant_combination | JSONB | - | - | Variant config (JSON) |
| recipe_scope | VARCHAR(20) | - | 'product' | 'product', 'global-modifier', 'product-override' |
| modifier_percentage | NUMERIC | - | 0 | Modifier % (for hybrid system) |
| modifier_type | VARCHAR(20) | - | 'percentage' | 'percentage', 'fixed', 'absolute' |
| is_override | BOOLEAN | - | FALSE | Override flag |
| is_active | BOOLEAN | - | TRUE | Active status |
| variant_name | VARCHAR(100) | - | - | Variant name |
| created_at | TIMESTAMP | - | NOW() | Record creation |
| updated_at | TIMESTAMP | - | NOW() | Last update |
| created_by | UUID | FK ‚Üí staff.id | - | Creator |

**Relationships:**
- Child of: products (CASCADE on delete)
- Parent of: recipe_ingredients

**Business Rules - Hybrid Recipe System:**
1. **Base Recipe**: recipe_type='base', recipe_scope='product' - Default ingredients
2. **Global Modifier**: recipe_scope='global-modifier' - Default variant adjustments
3. **Product Override**: recipe_scope='product-override', is_override=TRUE - Product-specific variant recipe

---

### 10. RECIPE_INGREDIENTS
**Purpose:** Ingredients needed per recipe
**Primary Key:** `id` (UUID)

| Column | Type | Constraints | Default | Purpose |
|--------|------|-------------|---------|---------|
| id | UUID | PK, NOT NULL | uuid_generate_v4() | Unique identifier |
| recipe_id | UUID | FK ‚Üí recipes.id | - | Parent recipe |
| inventory_item_id | UUID | FK ‚Üí inventory_items.id | - | Ingredient |
| ingredient_name | VARCHAR(100) | NOT NULL | - | Ingredient name |
| quantity_needed | NUMERIC | NOT NULL | - | Required quantity |
| unit | VARCHAR(20) | NOT NULL | - | Unit of measure |
| created_at | TIMESTAMP | - | NOW() | Record creation |

**Relationships:**
- Child of: recipes (CASCADE on delete)
- Child of: inventory_items (CASCADE on delete)

---

### 11. ORDERS
**Purpose:** Customer orders
**Primary Key:** `id` (UUID)

| Column | Type | Constraints | Default | Purpose |
|--------|------|-------------|---------|---------|
| id | UUID | PK, NOT NULL | uuid_generate_v4() | Unique identifier |
| order_number | VARCHAR(20) | UNIQUE, NOT NULL | - | Order # (e.g., ORD001) |
| customer_id | UUID | FK ‚Üí customers.id | - | Customer |
| customer_name | VARCHAR(100) | NOT NULL | - | Customer name |
| table_number | VARCHAR(20) | - | - | Table # (dine-in) |
| order_type | VARCHAR(20) | NOT NULL, CHECK | - | 'Dine in', 'Take Away', 'Delivery' |
| status | VARCHAR(30) | NOT NULL, CHECK | 'new' | Order status |
| subtotal | NUMERIC | NOT NULL | - | Before tax/discount |
| tax | NUMERIC | - | 0 | Tax amount |
| discount | NUMERIC | - | 0 | Discount amount |
| total | NUMERIC | NOT NULL | - | Final total |
| payment_method | VARCHAR(20) | CHECK | - | 'Cash', 'Card', 'E-Wallet' |
| payment_status | VARCHAR(20) | CHECK | 'pending' | Payment status |
| order_date | DATE | - | CURRENT_DATE | Order date |
| order_time | TIME | - | CURRENT_TIME | Order time |
| created_at | TIMESTAMP | - | NOW() | Record creation |
| updated_at | TIMESTAMP | - | NOW() | Last update |
| completed_at | TIMESTAMP | - | - | Completion time |
| created_by | UUID | FK ‚Üí staff.id | - | Staff who created |
| completed_by | UUID | FK ‚Üí staff.id | - | Staff who completed |

**Relationships:**
- Child of: customers
- Parent of: order_items, payment_transactions, usage_transactions

**Order Status Flow:**
- `new` ‚Üí `preparing` ‚Üí `partially-served` ‚Üí `served` ‚Üí `completed` / `cancelled`

**Payment Status:**
- `pending` ‚Üí `paid` / `refunded` / `cancelled`

**Trigger:**
- `update_orders_updated_at` - Auto-update updated_at on UPDATE

---

### 12. ORDER_ITEMS
**Purpose:** Items in each order
**Primary Key:** `id` (UUID)

| Column | Type | Constraints | Default | Purpose |
|--------|------|-------------|---------|---------|
| id | UUID | PK, NOT NULL | uuid_generate_v4() | Unique identifier |
| order_id | UUID | FK ‚Üí orders.id | - | Parent order |
| product_id | UUID | FK ‚Üí products.id | - | Product |
| product_name | VARCHAR(100) | NOT NULL | - | Product name |
| quantity | INTEGER | NOT NULL | - | Quantity ordered |
| base_price | NUMERIC | NOT NULL | - | Base price per item |
| variants | JSONB | - | - | Selected variants (JSON) |
| total_price | NUMERIC | NOT NULL | - | Total item price |
| served | BOOLEAN | - | FALSE | Served status |
| served_at | TIMESTAMP | - | - | Serve time |
| served_by | UUID | FK ‚Üí staff.id | - | Who served |
| served_by_role | VARCHAR(10) | - | - | Server role |
| served_by_code | VARCHAR(20) | - | - | Server code |
| notes | TEXT | - | - | Special notes |
| kitchen_status | VARCHAR(20) | - | 'pending' | Kitchen status |
| cooking_started_at | TIMESTAMP | - | - | Cooking start time |
| ready_at | TIMESTAMP | - | - | Ready time |
| ready_by | UUID | FK ‚Üí staff.id | - | Who prepared |
| created_at | TIMESTAMP | - | NOW() | Record creation |
| updated_at | TIMESTAMP | - | NOW() | Last update |

**Relationships:**
- Child of: orders (CASCADE on delete)
- Child of: products

**Kitchen Status:**
- `pending` ‚Üí `cooking` ‚Üí `ready` ‚Üí `served`

**Trigger:**
- `trigger_deduct_inventory_on_item` - Auto-deduct inventory when item inserted
- `update_order_items_updated_at` - Auto-update updated_at

---

### 13. USAGE_TRANSACTIONS
**Purpose:** Inventory usage history
**Primary Key:** `id` (UUID)

| Column | Type | Constraints | Default | Purpose |
|--------|------|-------------|---------|---------|
| id | UUID | PK, NOT NULL | uuid_generate_v4() | Unique identifier |
| timestamp | TIMESTAMP | - | NOW() | Transaction time |
| type | VARCHAR(20) | NOT NULL, CHECK | - | 'sale', 'restock', 'adjustment', 'waste' |
| product_id | UUID | FK ‚Üí products.id | - | Related product |
| product_name | VARCHAR(100) | - | - | Product name |
| quantity_sold | INTEGER | - | - | Quantity sold |
| notes | TEXT | - | - | Notes |
| order_id | UUID | FK ‚Üí orders.id | - | Related order |
| performed_by | UUID | FK ‚Üí staff.id | - | Who performed |
| created_at | TIMESTAMP | - | NOW() | Record creation |

**Relationships:**
- Child of: products, orders, staff
- Parent of: usage_transaction_details

**Transaction Types:**
- `sale` - Inventory used for order
- `restock` - Inventory replenished
- `adjustment` - Manual adjustment
- `waste` - Spoilage/waste

---

### 14. USAGE_TRANSACTION_DETAILS
**Purpose:** Detailed ingredient usage per transaction
**Primary Key:** `id` (UUID)

| Column | Type | Constraints | Default | Purpose |
|--------|------|-------------|---------|---------|
| id | UUID | PK, NOT NULL | uuid_generate_v4() | Unique identifier |
| usage_transaction_id | UUID | FK ‚Üí usage_transactions.id | - | Parent transaction |
| inventory_item_id | UUID | FK ‚Üí inventory_items.id | - | Ingredient used |
| ingredient_name | VARCHAR(100) | NOT NULL | - | Ingredient name |
| quantity_used | NUMERIC | NOT NULL | - | Quantity used |
| unit | VARCHAR(20) | NOT NULL | - | Unit of measure |
| previous_stock | NUMERIC | NOT NULL | - | Stock before |
| new_stock | NUMERIC | NOT NULL | - | Stock after |
| created_at | TIMESTAMP | - | NOW() | Record creation |

**Relationships:**
- Child of: usage_transactions (CASCADE on delete)
- Child of: inventory_items (CASCADE on delete)

---

### 15. POS_SESSIONS
**Purpose:** POS cashier sessions
**Primary Key:** `id` (UUID)

| Column | Type | Constraints | Default | Purpose |
|--------|------|-------------|---------|---------|
| id | UUID | PK, NOT NULL | uuid_generate_v4() | Unique identifier |
| staff_id | UUID | FK ‚Üí staff.id | - | Cashier |
| staff_name | VARCHAR(100) | NOT NULL | - | Cashier name |
| started_at | TIMESTAMP | - | NOW() | Session start |
| ended_at | TIMESTAMP | - | - | Session end |
| opening_cash | NUMERIC | - | 0 | Opening balance |
| closing_cash | NUMERIC | - | - | Closing balance |
| total_sales | NUMERIC | - | 0 | Total sales |
| total_orders | INTEGER | - | 0 | Order count |
| status | VARCHAR(20) | CHECK | 'active' | 'active', 'closed' |
| notes | TEXT | - | - | Session notes |
| created_at | TIMESTAMP | - | NOW() | Record creation |

**Relationships:**
- Child of: staff
- Parent of: payment_transactions

---

### 16. PAYMENT_TRANSACTIONS
**Purpose:** Payment records
**Primary Key:** `id` (UUID)

| Column | Type | Constraints | Default | Purpose |
|--------|------|-------------|---------|---------|
| id | UUID | PK, NOT NULL | uuid_generate_v4() | Unique identifier |
| order_id | UUID | FK ‚Üí orders.id | - | Related order |
| pos_session_id | UUID | FK ‚Üí pos_sessions.id | - | POS session |
| payment_method | VARCHAR(20) | NOT NULL, CHECK | - | 'Cash', 'Card', 'E-Wallet' |
| amount_paid | NUMERIC | NOT NULL | - | Amount paid |
| amount_change | NUMERIC | - | 0 | Change given |
| transaction_reference | VARCHAR(100) | - | - | External reference |
| status | VARCHAR(20) | CHECK | 'success' | 'success', 'failed', 'void' |
| created_at | TIMESTAMP | - | NOW() | Record creation |
| created_by | UUID | FK ‚Üí staff.id | - | Staff who processed |

**Relationships:**
- Child of: orders, pos_sessions, staff

---

### 17. TABLES
**Purpose:** Dine-in table management
**Primary Key:** `id` (UUID)

| Column | Type | Constraints | Default | Purpose |
|--------|------|-------------|---------|---------|
| id | UUID | PK, NOT NULL | uuid_generate_v4() | Unique identifier |
| table_number | VARCHAR(20) | UNIQUE, NOT NULL | - | Table number |
| capacity | INTEGER | - | 4 | Seating capacity |
| status | VARCHAR(20) | CHECK | 'available' | Table status |
| current_order_id | UUID | FK ‚Üí orders.id | - | Active order |
| created_at | TIMESTAMP | - | NOW() | Record creation |
| updated_at | TIMESTAMP | - | NOW() | Last update |

**Table Status:**
- `available`, `occupied`, `reserved`, `maintenance`

---

### 18. STAFF_SHIFTS
**Purpose:** Staff shift schedules
**Primary Key:** `id` (UUID)

| Column | Type | Constraints | Default | Purpose |
|--------|------|-------------|---------|---------|
| id | UUID | PK, NOT NULL | uuid_generate_v4() | Unique identifier |
| staff_id | UUID | FK ‚Üí staff.id | - | Staff member |
| shift_date | DATE | NOT NULL | - | Shift date |
| shift_type | VARCHAR(20) | CHECK | - | 'morning', 'afternoon', 'evening', 'full-day' |
| start_time | TIME | NOT NULL | - | Start time |
| end_time | TIME | NOT NULL | - | End time |
| status | VARCHAR(20) | CHECK | 'scheduled' | Shift status |
| created_at | TIMESTAMP | - | NOW() | Record creation |
| updated_at | TIMESTAMP | - | NOW() | Last update |
| created_by | UUID | FK ‚Üí staff.id | - | Creator |

**Shift Status:**
- `scheduled`, `in-progress`, `completed`, `missed`

**Trigger:**
- `update_staff_shifts_updated_at` - Auto-update updated_at

---

### 19. PRESENSI_SHIFT
**Purpose:** Staff attendance/presence records
**Primary Key:** `id` (UUID)

| Column | Type | Constraints | Default | Purpose |
|--------|------|-------------|---------|---------|
| id | UUID | PK, NOT NULL | uuid_generate_v4() | Unique identifier |
| staff_id | UUID | FK ‚Üí staff.id | - | Staff member |
| staff_name | VARCHAR(100) | NOT NULL | - | Staff name |
| shift_id | UUID | FK ‚Üí staff_shifts.id | - | Related shift |
| check_in | TIMESTAMP | NOT NULL | - | Check-in time |
| check_out | TIMESTAMP | - | - | Check-out time |
| presence_code | VARCHAR(20) | - | - | Code used |
| status | VARCHAR(20) | CHECK | 'on-time' | Attendance status |
| notes | TEXT | - | - | Notes |
| created_at | TIMESTAMP | - | NOW() | Record creation |
| updated_at | TIMESTAMP | - | NOW() | Last update |

**Attendance Status:**
- `on-time`, `late`, `absent`, `on-leave`

**Trigger:**
- `trigger_set_presensi_status` - Auto-set status based on check-in time
- `update_presensi_shift_updated_at` - Auto-update updated_at

---

### 20. PRESENCE_CODE
**Purpose:** Temporary attendance codes
**Primary Key:** `id` (UUID)

| Column | Type | Constraints | Default | Purpose |
|--------|------|-------------|---------|---------|
| id | UUID | PK, NOT NULL | uuid_generate_v4() | Unique identifier |
| code | VARCHAR(20) | UNIQUE, NOT NULL | - | Attendance code |
| expires_at | TIMESTAMP | NOT NULL | - | Expiry time |
| created_by | UUID | FK ‚Üí staff.id | - | Creator (owner/manager) |
| created_at | TIMESTAMP | - | NOW() | Record creation |
| used_count | INTEGER | - | 0 | Usage count |

**Business Rules:**
- Codes expire after set time
- Staff use code to check-in
- Owner/Manager generates codes

---

### 21. ACTIVITY_LOGS
**Purpose:** Audit trail for all actions
**Primary Key:** `id` (UUID)

| Column | Type | Constraints | Default | Purpose |
|--------|------|-------------|---------|---------|
| id | UUID | PK, NOT NULL | uuid_generate_v4() | Unique identifier |
| timestamp | TIMESTAMP | - | NOW() | Action time |
| user_id | UUID | FK ‚Üí staff.id | - | Who performed |
| user_name | VARCHAR(100) | NOT NULL | - | User name |
| user_role | VARCHAR(20) | NOT NULL | - | User role |
| user_email | VARCHAR(100) | - | - | User email |
| action | VARCHAR(20) | NOT NULL, CHECK | - | Action type |
| action_category | VARCHAR(20) | NOT NULL, CHECK | - | Category |
| action_description | TEXT | NOT NULL | - | Description |
| resource_type | VARCHAR(50) | - | - | Resource type |
| resource_id | VARCHAR(100) | - | - | Resource ID |
| resource_name | VARCHAR(200) | - | - | Resource name |
| previous_value | JSONB | - | - | Before change (JSON) |
| new_value | JSONB | - | - | After change (JSON) |
| changes_summary | TEXT[] | - | - | Change summary array |
| ip_address | VARCHAR(45) | - | - | IP address |
| device_info | TEXT | - | - | Device info |
| session_id | VARCHAR(100) | - | - | Session ID |
| severity | VARCHAR(20) | CHECK | 'info' | Log severity |
| tags | TEXT[] | - | - | Tags array |
| notes | TEXT | - | - | Additional notes |
| is_reversible | BOOLEAN | - | FALSE | Can be undone |
| created_at | TIMESTAMP | - | NOW() | Record creation |

**Action Types:**
- `CREATE`, `UPDATE`, `DELETE`, `LOGIN`, `LOGOUT`, `VOID`, `REFUND`, `VIEW`, `EXPORT`, `ADJUST`

**Action Categories:**
- `AUTH`, `SALES`, `INVENTORY`, `MENU`, `STAFF`, `FINANCIAL`, `SYSTEM`, `REPORT`

**Severity Levels:**
- `info`, `warning`, `critical`

---

### 22. ARCHIVES
**Purpose:** Monthly archive metadata
**Primary Key:** `id` (UUID)

| Column | Type | Constraints | Default | Purpose |
|--------|------|-------------|---------|---------|
| id | UUID | PK, NOT NULL | uuid_generate_v4() | Unique identifier |
| archive_id | TEXT | UNIQUE, NOT NULL | - | Archive ID |
| period_month | TEXT | NOT NULL | - | Month name |
| period_year | TEXT | NOT NULL | - | Year |
| generated_at | TIMESTAMPTZ | - | NOW() | Generation time |
| generated_by | UUID | FK ‚Üí staff.id (SET NULL) | - | Generator |
| data_types | TEXT[] | NOT NULL | '{}' | Data types included |
| total_records | JSONB | - | '{}' | Record counts (JSON) |
| key_metrics | JSONB | - | '{}' | Summary metrics (JSON) |
| file_metadata | JSONB | - | '{}' | File metadata (JSON) |
| csv_files | JSONB | - | - | CSV file info (JSON) |
| deleted_at | TIMESTAMPTZ | - | - | Soft delete time |
| deleted_by | UUID | FK ‚Üí staff.id (SET NULL) | - | Who deleted |
| created_at | TIMESTAMPTZ | - | NOW() | Record creation |
| updated_at | TIMESTAMPTZ | - | NOW() | Last update |

**Relationships:**
- Child of: staff (generated_by, deleted_by)

**Triggers:**
- `trigger_log_archive_activity` - Log archive generation/deletion to activity_logs
- `trigger_cleanup_archive_csv` - Cleanup CSV files on archive deletion

---

## üîó RELATIONSHIPS & FOREIGN KEYS

### Staff Relationships
```
staff (parent)
‚îú‚îÄ‚îÄ staff.created_by ‚Üí staff.id (self-reference)
‚îú‚îÄ‚îÄ orders.created_by ‚Üí staff.id
‚îú‚îÄ‚îÄ orders.completed_by ‚Üí staff.id
‚îú‚îÄ‚îÄ products.created_by ‚Üí staff.id
‚îú‚îÄ‚îÄ products.updated_by ‚Üí staff.id
‚îú‚îÄ‚îÄ recipes.created_by ‚Üí staff.id
‚îú‚îÄ‚îÄ activity_logs.user_id ‚Üí staff.id
‚îú‚îÄ‚îÄ archives.generated_by ‚Üí staff.id (SET NULL)
‚îú‚îÄ‚îÄ archives.deleted_by ‚Üí staff.id (SET NULL)
‚îú‚îÄ‚îÄ pos_sessions.staff_id ‚Üí staff.id
‚îú‚îÄ‚îÄ payment_transactions.created_by ‚Üí staff.id
‚îú‚îÄ‚îÄ presence_code.created_by ‚Üí staff.id
‚îú‚îÄ‚îÄ presensi_shift.staff_id ‚Üí staff.id (CASCADE)
‚îú‚îÄ‚îÄ staff_shifts.staff_id ‚Üí staff.id (CASCADE)
‚îú‚îÄ‚îÄ staff_shifts.created_by ‚Üí staff.id
‚îú‚îÄ‚îÄ order_items.served_by ‚Üí staff.id
‚îú‚îÄ‚îÄ order_items.ready_by ‚Üí staff.id
‚îî‚îÄ‚îÄ usage_transactions.performed_by ‚Üí staff.id
```

### Order Flow
```
orders (parent)
‚îú‚îÄ‚îÄ orders.customer_id ‚Üí customers.id
‚îú‚îÄ‚îÄ orders.created_by ‚Üí staff.id
‚îú‚îÄ‚îÄ orders.completed_by ‚Üí staff.id
‚îú‚îÄ‚îÄ order_items.order_id ‚Üí orders.id (CASCADE)
‚îú‚îÄ‚îÄ payment_transactions.order_id ‚Üí orders.id
‚îú‚îÄ‚îÄ usage_transactions.order_id ‚Üí orders.id
‚îî‚îÄ‚îÄ tables.current_order_id ‚Üí orders.id
```

### Product & Variants
```
products
‚îú‚îÄ‚îÄ products.category_id ‚Üí categories.id (SET NULL)
‚îú‚îÄ‚îÄ product_variant_groups.product_id ‚Üí products.id (CASCADE)
‚îî‚îÄ‚îÄ recipes.product_id ‚Üí products.id (CASCADE)

variant_groups
‚îú‚îÄ‚îÄ variant_options.variant_group_id ‚Üí variant_groups.id (CASCADE)
‚îî‚îÄ‚îÄ product_variant_groups.variant_group_id ‚Üí variant_groups.id (CASCADE)
```

### Inventory & Recipes
```
recipes
‚îú‚îÄ‚îÄ recipes.product_id ‚Üí products.id (CASCADE)
‚îî‚îÄ‚îÄ recipe_ingredients.recipe_id ‚Üí recipes.id (CASCADE)

inventory_items
‚îú‚îÄ‚îÄ recipe_ingredients.inventory_item_id ‚Üí inventory_items.id (CASCADE)
‚îî‚îÄ‚îÄ usage_transaction_details.inventory_item_id ‚Üí inventory_items.id (CASCADE)

usage_transactions
‚îî‚îÄ‚îÄ usage_transaction_details.usage_transaction_id ‚Üí usage_transactions.id (CASCADE)
```

### Cascade Behaviors Summary
**CASCADE (delete children when parent deleted):**
- orders ‚Üí order_items
- products ‚Üí recipes, product_variant_groups
- variant_groups ‚Üí variant_options, product_variant_groups
- recipes ‚Üí recipe_ingredients
- usage_transactions ‚Üí usage_transaction_details
- staff ‚Üí staff_shifts, presensi_shift
- inventory_items ‚Üí recipe_ingredients, usage_transaction_details

**SET NULL (set to NULL when parent deleted):**
- products.category_id (when category deleted)
- archives.generated_by, archives.deleted_by (when staff deleted)

**NO ACTION (prevent deletion if children exist):**
- Most staff relationships (prevent deleting staff with orders/logs)
- customer relationships
- product relationships in orders

---

## ‚öôÔ∏è TRIGGERS & FUNCTIONS

### Database Triggers (10 Active)

#### 1. update_updated_at_column()
**Type:** FUNCTION (trigger)  
**Applied to:** orders, order_items, presensi_shift, staff_shifts  
**Timing:** BEFORE UPDATE  
**Purpose:** Auto-update `updated_at` timestamp on row update

```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

**Triggers:**
- `update_orders_updated_at` on orders
- `update_order_items_updated_at` on order_items
- `update_presensi_shift_updated_at` on presensi_shift
- `update_staff_shifts_updated_at` on staff_shifts

---

#### 2. deduct_inventory_on_order_item()
**Type:** FUNCTION (trigger)  
**Applied to:** order_items  
**Timing:** AFTER INSERT  
**Purpose:** Auto-deduct inventory when order item inserted (Hybrid Recipe System)

**Flow:**
1. Check if order is paid (`payment_status = 'paid'`)
2. Get or create usage_transaction for order
3. Find base recipe for product
4. If order has variants:
   - Check for product-specific override recipe
   - If not found, apply global modifier to base recipe
5. Calculate total ingredient quantity (recipe √ó order quantity)
6. Deduct from inventory_items.current_stock
7. Update inventory_items.status based on stock level
8. Create usage_transaction_details records

**Trigger:**
```sql
CREATE TRIGGER trigger_deduct_inventory_on_item
AFTER INSERT ON order_items
FOR EACH ROW
EXECUTE FUNCTION deduct_inventory_on_order_item();
```

**Key Logic:**
- Hybrid Recipe: Override ‚Üí Base + Modifier
- Only deduct when payment_status = 'paid'
- Supports variant-specific recipes
- Logs all deductions in usage_transaction_details

---

#### 3. log_product_changes()
**Type:** FUNCTION (trigger)  
**Applied to:** products  
**Timing:** AFTER UPDATE  
**Purpose:** Log product changes to activity_logs

**What it logs:**
- Price changes
- Availability changes
- Stock changes
- Name/description updates

**Trigger:**
```sql
CREATE TRIGGER trigger_log_product_changes
AFTER UPDATE ON products
FOR EACH ROW
EXECUTE FUNCTION log_product_changes();
```

---

#### 4. set_presensi_status()
**Type:** FUNCTION (trigger)  
**Applied to:** presensi_shift  
**Timing:** BEFORE INSERT  
**Purpose:** Auto-set attendance status based on check-in time

**Logic:**
- Compare check_in time with shift.start_time
- If late > 15 minutes: status = 'late'
- Otherwise: status = 'on-time'

**Trigger:**
```sql
CREATE TRIGGER trigger_set_presensi_status
BEFORE INSERT ON presensi_shift
FOR EACH ROW
EXECUTE FUNCTION set_presensi_status();
```

---

#### 5. log_archive_activity()
**Type:** FUNCTION (trigger)  
**Applied to:** archives  
**Timing:** AFTER INSERT, AFTER UPDATE  
**Purpose:** Log archive creation/deletion to activity_logs

**Events:**
- INSERT: Log archive generation
- UPDATE (deleted_at changed): Log archive deletion

**Trigger:**
```sql
CREATE TRIGGER trigger_log_archive_activity
AFTER INSERT OR UPDATE ON archives
FOR EACH ROW
EXECUTE FUNCTION log_archive_activity();
```

---

#### 6. cleanup_archive_csv_files()
**Type:** FUNCTION (trigger)  
**Applied to:** archives  
**Timing:** AFTER UPDATE  
**Purpose:** Cleanup CSV files from storage when archive soft-deleted

**Trigger:**
```sql
CREATE TRIGGER trigger_cleanup_archive_csv
AFTER UPDATE ON archives
FOR EACH ROW
EXECUTE FUNCTION cleanup_archive_csv_files();
```

---

## üìã BUSINESS LOGIC RULES

### 1. Order Status Flow
```
new ‚Üí preparing ‚Üí partially-served ‚Üí served ‚Üí completed
  ‚Üì                                              ‚Üì
cancelled ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üê ‚Üì
```

**Status Definitions:**
- `new` - Order created, not started
- `preparing` - Kitchen/barista working on order
- `partially-served` - Some items served, others pending
- `served` - All items ready/served
- `completed` - Payment done, order closed
- `cancelled` - Order cancelled

**Rules:**
- Can only cancel before `served`
- Payment required before `completed`
- `completed` requires payment_status = 'paid'

---

### 2. Payment Status Flow
```
pending ‚Üí paid
   ‚Üì       ‚Üì
   ‚Üí cancelled
   ‚Üí refunded
```

**Rules:**
- Orders start with payment_status = 'pending'
- Inventory deduction triggers when payment_status = 'paid'
- Refunds require activity_log entry

---

### 3. Inventory Auto-Deduction (Hybrid Recipe System)

**System:** Base Recipe + Modifiers + Overrides

**Recipe Types:**
1. **Base Recipe** (recipe_type='base', recipe_scope='product')
   - Default ingredients for product
   - Applied to all orders

2. **Global Modifier** (recipe_scope='global-modifier')
   - Default variant adjustments (e.g., Large = +50% coffee beans)
   - Applied when no override exists

3. **Product Override** (recipe_scope='product-override', is_override=true)
   - Product-specific variant recipe
   - Overrides global modifier

**Deduction Flow:**
```
Order Item Inserted (with payment_status='paid')
  ‚Üì
Get Base Recipe
  ‚Üì
Has Variants? ‚Üí NO ‚Üí Use Base Recipe only
  ‚Üì YES
  ‚Üì
Check Product Override ‚Üí Found ‚Üí Use Override Recipe
  ‚Üì Not Found
  ‚Üì
Apply Global Modifier to Base Recipe (+/- %)
  ‚Üì
Calculate Total Quantity (recipe √ó order.quantity)
  ‚Üì
Deduct from inventory_items.current_stock
  ‚Üì
Update inventory_items.status
  ‚Üì
Create usage_transaction + usage_transaction_details
```

**Example:**
- Product: Americano
- Base: 20g coffee beans, 200ml water
- Variant: Large (Global Modifier +50%)
- Order: 2x Americano Large
- Deduction: (20g √ó 1.5) √ó 2 = 60g coffee beans

---

### 4. Inventory Stock Status Calculation

**Auto-calculated on every stock change:**
```sql
status = CASE 
  WHEN current_stock <= 0 THEN 'out-of-stock'
  WHEN current_stock <= reorder_level THEN 'low-stock'
  ELSE 'in-stock'
END
```

**Triggers update when:**
- Order item inserted (inventory deducted)
- Manual adjustment
- Restock transaction

---

### 5. Staff Authentication Rules

**Owner/Manager:**
- Login: email + password_hash (bcrypt)
- Password permanent
- Can reset own password

**Staff:**
- Login: staff_code + login_code
- login_code expires after 24 hours
- Code generated by owner/manager
- Format: 8-digit code

**Login Code Generation:**
```sql
UPDATE staff 
SET login_code = RANDOM_8_DIGIT_CODE,
    login_code_expires_at = NOW() + INTERVAL '24 hours'
WHERE id = $staff_id
```

---

### 6. Customer Loyalty System

**Point Accumulation:**
- Default: 1 point per Rp 10,000 spent
- Stored in customers.loyalty_points

**Total Spent Tracking:**
```sql
-- On order completion:
UPDATE customers 
SET total_spent = total_spent + order.total,
    visit_count = visit_count + 1
WHERE id = order.customer_id
```

---

### 7. Kitchen Status Flow (order_items)
```
pending ‚Üí cooking ‚Üí ready ‚Üí served
```

**Timestamps:**
- `pending` - order created
- `cooking` - cooking_started_at set
- `ready` - ready_at set, ready_by set
- `served` - served_at set, served_by set

---

## üîç COMMON QUERY PATTERNS

### 1. Login Validation

**Owner/Manager Login:**
```sql
SELECT 
  id, 
  name, 
  email, 
  role, 
  staff_type, 
  password_hash,
  status
FROM staff 
WHERE email = $email 
  AND role IN ('owner', 'manager')
  AND status = 'active'
LIMIT 1;
```

**Staff Login:**
```sql
SELECT 
  id, 
  name, 
  staff_code, 
  role, 
  staff_type, 
  status,
  login_code_expires_at
FROM staff 
WHERE staff_code = $staff_code 
  AND login_code = $login_code
  AND role = 'staff'
  AND status = 'active'
  AND login_code_expires_at > NOW()
LIMIT 1;
```

**Customer Login:**
```sql
SELECT 
  id, 
  name, 
  phone, 
  loyalty_points, 
  member_since,
  status
FROM customers 
WHERE phone = $phone 
  AND status = 'active'
LIMIT 1;
```

---

### 2. Get Menu with Variants

```sql
-- Get all active products with category
SELECT 
  p.id,
  p.name,
  p.description,
  p.price,
  p.image,
  p.available,
  p.has_variants,
  c.name as category_name,
  c.icon as category_icon
FROM products p
LEFT JOIN categories c ON p.category_id = c.id
WHERE p.available = TRUE
  AND c.is_active = TRUE
ORDER BY c.sort_order, p.name;

-- Get variant groups for product
SELECT 
  vg.id as group_id,
  vg.name as group_name,
  vg.type as group_type,
  vg.required,
  vo.id as option_id,
  vo.name as option_name,
  vo.price_modifier,
  vo.sort_order
FROM product_variant_groups pvg
JOIN variant_groups vg ON pvg.variant_group_id = vg.id
JOIN variant_options vo ON vo.variant_group_id = vg.id
WHERE pvg.product_id = $product_id
  AND vg.is_active = TRUE
  AND vo.is_active = TRUE
ORDER BY vg.name, vo.sort_order;
```

---

### 3. Check Inventory Stock

**Get all low/out-of-stock items:**
```sql
SELECT 
  id,
  name,
  category,
  current_stock,
  reorder_level,
  unit,
  status,
  supplier,
  last_restocked
FROM inventory_items
WHERE status IN ('low-stock', 'out-of-stock')
ORDER BY 
  CASE status 
    WHEN 'out-of-stock' THEN 1 
    WHEN 'low-stock' THEN 2 
  END,
  name;
```

**Get stock for specific ingredient:**
```sql
SELECT 
  current_stock,
  reorder_level,
  unit,
  status
FROM inventory_items
WHERE id = $inventory_item_id;
```

---

### 4. Create Order with Items

```sql
-- Insert order
INSERT INTO orders (
  order_number,
  customer_id,
  customer_name,
  table_number,
  order_type,
  status,
  subtotal,
  tax,
  discount,
  total,
  payment_method,
  payment_status,
  created_by
) VALUES (
  $order_number,
  $customer_id,
  $customer_name,
  $table_number,
  $order_type,
  'new',
  $subtotal,
  $tax,
  $discount,
  $total,
  $payment_method,
  'pending',
  $staff_id
) RETURNING id;

-- Insert order items
INSERT INTO order_items (
  order_id,
  product_id,
  product_name,
  quantity,
  base_price,
  variants,
  total_price,
  notes
) VALUES (
  $order_id,
  $product_id,
  $product_name,
  $quantity,
  $base_price,
  $variants::jsonb, -- {"Size": ["Large"], "Milk Type": ["Oat Milk"]}
  $total_price,
  $notes
);
```

---

### 5. Get Order Details with Items

```sql
SELECT 
  o.id,
  o.order_number,
  o.customer_name,
  o.table_number,
  o.order_type,
  o.status,
  o.payment_status,
  o.subtotal,
  o.tax,
  o.discount,
  o.total,
  o.payment_method,
  o.created_at,
  o.completed_at,
  s.name as created_by_name,
  
  -- Order items as JSON
  json_agg(
    json_build_object(
      'id', oi.id,
      'product_name', oi.product_name,
      'quantity', oi.quantity,
      'base_price', oi.base_price,
      'variants', oi.variants,
      'total_price', oi.total_price,
      'served', oi.served,
      'kitchen_status', oi.kitchen_status,
      'notes', oi.notes
    )
  ) as items
  
FROM orders o
LEFT JOIN staff s ON o.created_by = s.id
LEFT JOIN order_items oi ON o.id = oi.order_id
WHERE o.id = $order_id
GROUP BY o.id, s.name;
```

---

### 6. Sales Report (Daily/Monthly)

**Daily Sales:**
```sql
SELECT 
  DATE(created_at) as date,
  COUNT(id) as total_orders,
  SUM(total) as total_revenue,
  SUM(subtotal) as subtotal,
  SUM(tax) as total_tax,
  SUM(discount) as total_discount,
  AVG(total) as average_order_value
FROM orders
WHERE DATE(created_at) = $date
  AND payment_status = 'paid'
  AND status = 'completed'
GROUP BY DATE(created_at);
```

**Sales by Product:**
```sql
SELECT 
  oi.product_name,
  COUNT(oi.id) as times_ordered,
  SUM(oi.quantity) as total_quantity,
  SUM(oi.total_price) as total_revenue
FROM order_items oi
JOIN orders o ON oi.order_id = o.id
WHERE DATE(o.created_at) = $date
  AND o.payment_status = 'paid'
GROUP BY oi.product_name
ORDER BY total_revenue DESC;
```

---

### 7. Activity Logs Filtering

**Get logs by user:**
```sql
SELECT 
  timestamp,
  action,
  action_category,
  action_description,
  resource_type,
  resource_name,
  severity
FROM activity_logs
WHERE user_id = $user_id
ORDER BY timestamp DESC
LIMIT 100;
```

**Get critical logs:**
```sql
SELECT 
  timestamp,
  user_name,
  user_role,
  action,
  action_description,
  resource_name
FROM activity_logs
WHERE severity = 'critical'
  AND timestamp >= NOW() - INTERVAL '7 days'
ORDER BY timestamp DESC;
```

---

### 8. Staff Attendance Report

```sql
SELECT 
  s.name as staff_name,
  s.staff_code,
  s.staff_type,
  ps.check_in,
  ps.check_out,
  ps.status,
  ss.shift_type,
  ss.start_time,
  ss.end_time,
  EXTRACT(EPOCH FROM (ps.check_out - ps.check_in))/3600 as hours_worked
FROM presensi_shift ps
JOIN staff s ON ps.staff_id = s.id
LEFT JOIN staff_shifts ss ON ps.shift_id = ss.id
WHERE DATE(ps.check_in) = $date
ORDER BY ps.check_in;
```

---

## üîó COMPLEX JOIN EXAMPLES

### 1. Complete Order Details with All Relations

```sql
SELECT 
  -- Order info
  o.id,
  o.order_number,
  o.order_type,
  o.status,
  o.payment_status,
  o.total,
  
  -- Customer info
  c.name as customer_name,
  c.phone as customer_phone,
  c.loyalty_points,
  
  -- Staff info
  s.name as created_by_name,
  s.staff_type,
  
  -- Order items with variants
  oi.product_name,
  oi.quantity,
  oi.variants,
  oi.total_price,
  oi.kitchen_status,
  
  -- Product details
  p.price as base_product_price,
  p.image as product_image,
  
  -- Category
  cat.name as category_name
  
FROM orders o
LEFT JOIN customers c ON o.customer_id = c.id
LEFT JOIN staff s ON o.created_by = s.id
LEFT JOIN order_items oi ON o.id = oi.order_id
LEFT JOIN products p ON oi.product_id = p.id
LEFT JOIN categories cat ON p.category_id = cat.id
WHERE o.id = $order_id;
```

---

### 2. Product with Recipes and Inventory Details

```sql
SELECT 
  -- Product
  p.id as product_id,
  p.name as product_name,
  p.price,
  
  -- Recipe
  r.id as recipe_id,
  r.recipe_type,
  r.recipe_scope,
  r.variant_combination,
  
  -- Ingredients
  ri.quantity_needed,
  ri.unit,
  
  -- Inventory item
  ii.id as inventory_item_id,
  ii.name as ingredient_name,
  ii.current_stock,
  ii.status as stock_status,
  ii.unit as stock_unit,
  
  -- Calculate if enough stock
  CASE 
    WHEN ii.current_stock >= ri.quantity_needed THEN true
    ELSE false
  END as has_enough_stock
  
FROM products p
JOIN recipes r ON p.id = r.product_id
JOIN recipe_ingredients ri ON r.id = ri.recipe_id
JOIN inventory_items ii ON ri.inventory_item_id = ii.id
WHERE p.id = $product_id
  AND r.recipe_type = 'base'
ORDER BY ii.name;
```

---

### 3. Inventory Usage History with Order Details

```sql
SELECT 
  -- Usage transaction
  ut.id as transaction_id,
  ut.timestamp,
  ut.type as transaction_type,
  
  -- Order details (if applicable)
  o.order_number,
  o.customer_name,
  o.total as order_total,
  
  -- Staff who performed
  s.name as performed_by_name,
  s.role as staff_role,
  
  -- Ingredient details
  utd.ingredient_name,
  utd.quantity_used,
  utd.unit,
  utd.previous_stock,
  utd.new_stock,
  
  -- Current inventory status
  ii.current_stock,
  ii.status as current_status
  
FROM usage_transactions ut
LEFT JOIN orders o ON ut.order_id = o.id
LEFT JOIN staff s ON ut.performed_by = s.id
JOIN usage_transaction_details utd ON ut.id = utd.usage_transaction_id
JOIN inventory_items ii ON utd.inventory_item_id = ii.id
WHERE ut.timestamp >= $start_date
  AND ut.timestamp <= $end_date
ORDER BY ut.timestamp DESC, utd.ingredient_name;
```

---

### 4. Staff Performance Report

```sql
SELECT 
  -- Staff info
  s.id as staff_id,
  s.name as staff_name,
  s.staff_code,
  s.staff_type,
  
  -- Orders created
  COUNT(DISTINCT o.id) as orders_created,
  SUM(o.total) as total_sales,
  AVG(o.total) as average_order_value,
  
  -- Items served
  COUNT(DISTINCT oi.id) FILTER (WHERE oi.served_by = s.id) as items_served,
  
  -- Attendance
  COUNT(DISTINCT ps.id) as days_attended,
  COUNT(DISTINCT ps.id) FILTER (WHERE ps.status = 'late') as days_late,
  
  -- POS Sessions
  COUNT(DISTINCT poss.id) as pos_sessions,
  SUM(poss.total_sales) as pos_total_sales
  
FROM staff s
LEFT JOIN orders o ON s.id = o.created_by
  AND DATE(o.created_at) >= $start_date
  AND DATE(o.created_at) <= $end_date
LEFT JOIN order_items oi ON s.id = oi.served_by
LEFT JOIN presensi_shift ps ON s.id = ps.staff_id
  AND DATE(ps.check_in) >= $start_date
  AND DATE(ps.check_in) <= $end_date
LEFT JOIN pos_sessions poss ON s.id = poss.staff_id
  AND DATE(poss.started_at) >= $start_date
  AND DATE(poss.started_at) <= $end_date
WHERE s.role = 'staff'
  AND s.status = 'active'
GROUP BY s.id, s.name, s.staff_code, s.staff_type
ORDER BY total_sales DESC NULLS LAST;
```

---

## üìù ENUM VALUES & CONSTANTS

### Staff
- **role**: `'owner'`, `'manager'`, `'staff'`
- **staff_type**: `'barista'`, `'kitchen'`, `'waiter'`, `'cashier'`
- **status**: `'active'`, `'inactive'`, `'on-leave'`, `'terminated'`

### Customers
- **status**: `'active'`, `'inactive'`, `'blocked'`

### Categories
- **type**: `'food'` (default), others allowed

### Variant Groups
- **type**: `'single'`, `'multiple'`

### Inventory Items
- **category**: `'Ingredients'`, `'Packaging'`, `'Supplies'`
- **status**: `'in-stock'`, `'low-stock'`, `'out-of-stock'`

### Recipes
- **recipe_type**: `'base'`, `'variant-specific'`, `'variant-modifier'`
- **recipe_scope**: `'product'`, `'global-modifier'`, `'product-override'`
- **modifier_type**: `'percentage'`, `'fixed'`, `'absolute'`

### Usage Transactions
- **type**: `'sale'`, `'restock'`, `'adjustment'`, `'waste'`

### Orders
- **order_type**: `'Dine in'`, `'Take Away'`, `'Delivery'`
- **status**: `'new'`, `'preparing'`, `'partially-served'`, `'served'`, `'completed'`, `'cancelled'`
- **payment_method**: `'Cash'`, `'Card'`, `'E-Wallet'`
- **payment_status**: `'pending'`, `'paid'`, `'refunded'`, `'cancelled'`

### Order Items
- **kitchen_status**: `'pending'`, `'cooking'`, `'ready'`, `'served'`

### POS Sessions
- **status**: `'active'`, `'closed'`

### Payment Transactions
- **payment_method**: `'Cash'`, `'Card'`, `'E-Wallet'`
- **status**: `'success'`, `'failed'`, `'void'`

### Staff Shifts
- **shift_type**: `'morning'`, `'afternoon'`, `'evening'`, `'full-day'`
- **status**: `'scheduled'`, `'in-progress'`, `'completed'`, `'missed'`

### Presensi Shift (Attendance)
- **status**: `'on-time'`, `'late'`, `'absent'`, `'on-leave'`

### Tables
- **status**: `'available'`, `'occupied'`, `'reserved'`, `'maintenance'`

### Activity Logs
- **action**: `'CREATE'`, `'UPDATE'`, `'DELETE'`, `'LOGIN'`, `'LOGOUT'`, `'VOID'`, `'REFUND'`, `'VIEW'`, `'EXPORT'`, `'ADJUST'`
- **action_category**: `'AUTH'`, `'SALES'`, `'INVENTORY'`, `'MENU'`, `'STAFF'`, `'FINANCIAL'`, `'SYSTEM'`, `'REPORT'`
- **severity**: `'info'`, `'warning'`, `'critical'`

---

## üßÆ CALCULATED FIELDS & FORMULAS

### Order Total Calculation
```sql
-- Frontend calculation before INSERT
subtotal = SUM(order_items.total_price)
tax = subtotal √ó tax_rate (e.g., 0.10 for 10%)
total = subtotal + tax - discount

-- Example:
subtotal = 50000
tax = 50000 √ó 0.10 = 5000
discount = 5000
total = 50000 + 5000 - 5000 = 50000
```

### Order Item Price with Variants
```sql
-- Calculate in frontend
base_price = product.price
variant_price_adjustment = SUM(selected_variants.price_modifier)
item_price = base_price + variant_price_adjustment
total_price = item_price √ó quantity

-- Example:
-- Americano: 25000
-- Large: +5000
-- Oat Milk: +7000
-- Quantity: 2
total_price = (25000 + 5000 + 7000) √ó 2 = 74000
```

### Inventory Stock Status
```sql
-- Auto-calculated in trigger
status = CASE 
  WHEN current_stock <= 0 THEN 'out-of-stock'
  WHEN current_stock <= reorder_level THEN 'low-stock'
  ELSE 'in-stock'
END
```

### Recipe Modifier Application (Hybrid System)
```sql
-- Base recipe: 20g coffee
-- Modifier: +50% for Large
adjusted_quantity = base_quantity √ó (1 + modifier_percentage/100)
adjusted_quantity = 20 √ó (1 + 50/100) = 20 √ó 1.5 = 30g

-- For order quantity = 2:
total_deduction = adjusted_quantity √ó order_quantity
total_deduction = 30 √ó 2 = 60g
```

### Customer Total Spent
```sql
-- Updated on order completion
UPDATE customers 
SET total_spent = total_spent + order.total,
    visit_count = visit_count + 1
WHERE id = order.customer_id;
```

### Staff Hours Worked
```sql
-- Calculate in query
hours_worked = EXTRACT(EPOCH FROM (check_out - check_in)) / 3600

-- Example:
-- check_in: 2024-01-15 08:00:00
-- check_out: 2024-01-15 16:30:00
-- hours_worked = 8.5 hours
```

### POS Session Totals
```sql
-- Updated when payments recorded
UPDATE pos_sessions
SET total_sales = total_sales + payment.amount_paid,
    total_orders = total_orders + 1
WHERE id = payment.pos_session_id;
```

---

## ‚ö° INDEXES & PERFORMANCE

### Existing Indexes (from database_schema.sql)

**Staff Table:**
```sql
CREATE INDEX idx_staff_code ON staff(staff_code);
CREATE INDEX idx_staff_email ON staff(email);
CREATE INDEX idx_staff_role ON staff(role);
CREATE INDEX idx_staff_status ON staff(status);
```
**Usage:** Fast lookup for login, role filtering

**Customers Table:**
```sql
CREATE INDEX idx_customers_phone ON customers(phone);
CREATE INDEX idx_customers_status ON customers(status);
```
**Usage:** Fast customer login, status filtering

**Products Table:**
```sql
CREATE INDEX idx_products_category ON products(category_id);
CREATE INDEX idx_products_available ON products(available);
```
**Usage:** Menu filtering by category, availability

**Orders Table:**
```sql
CREATE INDEX idx_orders_number ON orders(order_number);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_date ON orders(order_date);
CREATE INDEX idx_orders_customer ON orders(customer_id);
```
**Usage:** Order lookup, status filtering, date range queries, customer history

**Inventory Items:**
```sql
CREATE INDEX idx_inventory_status ON inventory_items(status);
CREATE INDEX idx_inventory_category ON inventory_items(category);
```
**Usage:** Low stock alerts, category filtering

**Activity Logs:**
```sql
CREATE INDEX idx_activity_user ON activity_logs(user_id);
CREATE INDEX idx_activity_action ON activity_logs(action);
CREATE INDEX idx_activity_category ON activity_logs(action_category);
CREATE INDEX idx_activity_timestamp ON activity_logs(timestamp DESC);
CREATE INDEX idx_activity_severity ON activity_logs(severity);
```
**Usage:** User activity tracking, action filtering, chronological queries, critical alerts

**Archives:**
```sql
CREATE INDEX idx_archives_period ON archives(period_year, period_month);
CREATE INDEX idx_archives_generated_by ON archives(generated_by);
CREATE INDEX idx_archives_deleted_at ON archives(deleted_at);
```
**Usage:** Period lookup, user tracking, active archives filtering

### Performance Tips

**1. Use indexes for WHERE clauses:**
```sql
-- GOOD: Uses idx_orders_date
SELECT * FROM orders WHERE order_date = '2024-01-15';

-- BAD: No index on created_at timestamp
SELECT * FROM orders WHERE created_at > '2024-01-15 00:00:00';
-- Consider: Use order_date instead or create index on created_at
```

**2. Limit result sets:**
```sql
-- Always use LIMIT for large tables
SELECT * FROM activity_logs 
ORDER BY timestamp DESC 
LIMIT 100; -- Good practice
```

**3. Avoid SELECT *:**
```sql
-- BAD
SELECT * FROM orders;

-- GOOD: Select only needed columns
SELECT id, order_number, status, total FROM orders;
```

**4. Use JOINs efficiently:**
```sql
-- Use INNER JOIN when you only need matching records
SELECT o.*, c.name 
FROM orders o
INNER JOIN customers c ON o.customer_id = c.id;

-- Use LEFT JOIN when you need all records from left table
SELECT o.*, c.name 
FROM orders o
LEFT JOIN customers c ON o.customer_id = c.id;
```

**5. Batch inserts:**
```sql
-- GOOD: Insert multiple rows at once
INSERT INTO order_items (order_id, product_id, quantity, ...)
VALUES 
  ($1, $2, $3, ...),
  ($1, $2, $3, ...),
  ($1, $2, $3, ...);
```

---

## ‚ö†Ô∏è ERROR SCENARIOS & VALIDATION

### Unique Constraint Violations

**1. Duplicate staff_code:**
```sql
ERROR: duplicate key value violates unique constraint "staff_staff_code_key"
```
**Solution:** Generate unique staff_code before INSERT

**2. Duplicate email:**
```sql
ERROR: duplicate key value violates unique constraint "staff_email_key"
```
**Solution:** Check if email exists before INSERT/UPDATE

**3. Duplicate order_number:**
```sql
ERROR: duplicate key value violates unique constraint "orders_order_number_key"
```
**Solution:** Generate sequential order numbers (ORD001, ORD002, ...)

---

### Foreign Key Violations

**1. Invalid staff reference:**
```sql
ERROR: insert or update on table "orders" violates foreign key constraint
DETAIL: Key (created_by)=(xxx) is not present in table "staff"
```
**Solution:** Verify staff_id exists before creating order

**2. Invalid product reference:**
```sql
ERROR: insert or update on table "order_items" violates foreign key constraint
DETAIL: Key (product_id)=(xxx) is not present in table "products"
```
**Solution:** Check product exists and is available

**3. Cannot delete staff with orders:**
```sql
ERROR: update or delete on table "staff" violates foreign key constraint
DETAIL: Key (id)=(xxx) is still referenced from table "orders"
```
**Solution:** Cannot delete staff with existing orders (NO ACTION). Set status='inactive' instead.

---

### CHECK Constraint Violations

**1. Invalid role:**
```sql
ERROR: new row violates check constraint "staff_role_check"
DETAIL: Failing row contains role='admin'
```
**Valid values:** `'owner'`, `'manager'`, `'staff'`

**2. Invalid order_type:**
```sql
ERROR: new row violates check constraint "orders_order_type_check"
```
**Valid values:** `'Dine in'`, `'Take Away'`, `'Delivery'`

**3. Invalid payment_method:**
```sql
ERROR: new row violates check constraint "orders_payment_method_check"
```
**Valid values:** `'Cash'`, `'Card'`, `'E-Wallet'`

---

### NOT NULL Violations

**1. Missing required fields:**
```sql
ERROR: null value in column "customer_name" violates not-null constraint
```
**Solution:** Ensure all required fields are provided

**2. Missing order total:**
```sql
ERROR: null value in column "total" violates not-null constraint
```
**Solution:** Calculate total before INSERT

---

### Business Logic Errors

**1. Insufficient inventory:**
```
No error thrown, but inventory becomes negative
```
**Solution:** Check inventory before allowing order
```sql
SELECT current_stock 
FROM inventory_items 
WHERE id = $item_id;

IF current_stock < quantity_needed THEN
  RAISE EXCEPTION 'Insufficient stock for %', item_name;
END IF;
```

**2. Expired login code:**
```
Login fails, but no clear error
```
**Solution:** Check login_code_expires_at
```sql
WHERE login_code_expires_at > NOW()
```

**3. Staff type mismatch:**
```
Staff type 'barista' trying to access cashier functions
```
**Solution:** Check staff_type permissions in application layer

**4. Order already paid:**
```
Attempting to modify paid order
```
**Solution:** Check payment_status before allowing edits
```sql
IF payment_status = 'paid' THEN
  RAISE EXCEPTION 'Cannot modify paid order';
END IF;
```

---

## üìä DATA FLOW DIAGRAMS

### 1. Order Creation & Inventory Deduction Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   CASHIER   ‚îÇ
‚îÇ   (Staff)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 1. Create Order
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  INSERT INTO orders         ‚îÇ
‚îÇ  - customer_id              ‚îÇ
‚îÇ  - order_type               ‚îÇ
‚îÇ  - payment_status='pending' ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 2. Add Items
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  INSERT INTO order_items    ‚îÇ
‚îÇ  - order_id                 ‚îÇ
‚îÇ  - product_id               ‚îÇ
‚îÇ  - variants (JSONB)         ‚îÇ
‚îÇ  - quantity                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ ‚úì TRIGGER: trigger_deduct_inventory_on_item
       ‚îÇ
       ‚îÇ 3. Check Payment Status
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      NO
‚îÇ payment_status   ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ Return (no deduction)
‚îÇ   = 'paid'?      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ YES
     ‚îÇ 4. Get/Create usage_transaction
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  usage_transactions         ‚îÇ
‚îÇ  - order_id                 ‚îÇ
‚îÇ  - type='sale'              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 5. Find Base Recipe
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  SELECT FROM recipes        ‚îÇ
‚îÇ  WHERE product_id = X       ‚îÇ
‚îÇ    AND recipe_type='base'   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 6. Has Variants?
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      NO   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  variants != {}  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ Use Base Recipe ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ YES                              ‚îÇ
     ‚îÇ 7. Check Override                ‚îÇ
     ‚ñº                                  ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ
‚îÇ  Product-specific Override? ‚îÇ        ‚îÇ
‚îÇ  (is_override=true)         ‚îÇ        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ
     ‚îÇ Found        ‚îÇ Not Found        ‚îÇ
     ‚ñº              ‚ñº                  ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇUse Override‚îÇ  ‚îÇApply Global    ‚îÇ    ‚îÇ
‚îÇ   Recipe   ‚îÇ  ‚îÇModifier to Base‚îÇ    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
     ‚îÇ              ‚îÇ                 ‚îÇ
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
                    ‚îÇ 8. Calculate Quantities
                    ‚ñº
     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
     ‚îÇ  quantity_needed √ó modifier       ‚îÇ
     ‚îÇ  √ó order.quantity                 ‚îÇ
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚îÇ 9. Deduct from Inventory
                 ‚ñº
     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
     ‚îÇ  UPDATE inventory_items           ‚îÇ
     ‚îÇ  SET current_stock = current_stock‚îÇ
     ‚îÇ      - calculated_quantity        ‚îÇ
     ‚îÇ  SET status = (calculated)        ‚îÇ
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚îÇ 10. Log Details
                 ‚ñº
     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
     ‚îÇ  INSERT usage_transaction_details ‚îÇ
     ‚îÇ  - inventory_item_id              ‚îÇ
     ‚îÇ  - quantity_used                  ‚îÇ
     ‚îÇ  - previous_stock                 ‚îÇ
     ‚îÇ  - new_stock                      ‚îÇ
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### 2. Staff Authentication Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  LOGIN PAGE  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ Check User Type
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Owner/Manager  ‚îÇ       Staff        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                   ‚îÇ
         ‚îÇ Email+Password    ‚îÇ Staff Code+Login Code
         ‚ñº                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ SELECT * FROM  ‚îÇ   ‚îÇ SELECT * FROM   ‚îÇ
‚îÇ staff WHERE    ‚îÇ   ‚îÇ staff WHERE     ‚îÇ
‚îÇ email=$email   ‚îÇ   ‚îÇ staff_code=$code‚îÇ
‚îÇ AND role IN    ‚îÇ   ‚îÇ AND login_code= ‚îÇ
‚îÇ ('owner',      ‚îÇ   ‚îÇ $code AND       ‚îÇ
‚îÇ  'manager')    ‚îÇ   ‚îÇ expires_at>NOW()‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                     ‚îÇ
         ‚îÇ Verify bcrypt       ‚îÇ Code Valid?
         ‚ñº                     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Password       ‚îÇ   ‚îÇ Expiry Check    ‚îÇ
‚îÇ Match?         ‚îÇ   ‚îÇ OK?             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ YES                     ‚îÇ YES
     ‚îÇ                         ‚îÇ
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ
                 ‚îÇ Create Session
                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  localStorage.setItem:        ‚îÇ
‚îÇ  - user_id                    ‚îÇ
‚îÇ  - user_name                  ‚îÇ
‚îÇ  - user_role                  ‚îÇ
‚îÇ  - user_type (staff_type)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚îÇ Log Activity
                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  INSERT INTO activity_logs    ‚îÇ
‚îÇ  - action='LOGIN'             ‚îÇ
‚îÇ  - action_category='AUTH'     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### 3. Payment Processing Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   CASHIER    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 1. Select Order
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  GET order WHERE    ‚îÇ
‚îÇ  payment_status=    ‚îÇ
‚îÇ  'pending'          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 2. Confirm Payment
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  UPDATE orders              ‚îÇ
‚îÇ  SET payment_status='paid'  ‚îÇ
‚îÇ      payment_method=$method ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 3. Create Payment Record
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  INSERT payment_transactions‚îÇ
‚îÇ  - order_id                 ‚îÇ
‚îÇ  - pos_session_id           ‚îÇ
‚îÇ  - payment_method           ‚îÇ
‚îÇ  - amount_paid              ‚îÇ
‚îÇ  - amount_change            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 4. Update POS Session
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  UPDATE pos_sessions        ‚îÇ
‚îÇ  SET total_sales = total    ‚îÇ
‚îÇ      + order.total          ‚îÇ
‚îÇ      total_orders++         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 5. Update Customer
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  UPDATE customers           ‚îÇ
‚îÇ  SET total_spent = total    ‚îÇ
‚îÇ      + order.total          ‚îÇ
‚îÇ      visit_count++          ‚îÇ
‚îÇ      loyalty_points++       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 6. Inventory Deduction
       ‚îÇ    ‚úì Trigger fires on order_items
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Auto-deduct inventory via  ‚îÇ
‚îÇ  deduct_inventory_on_order  ‚îÇ
‚îÇ  _item() trigger            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 7. Complete Order
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  UPDATE orders              ‚îÇ
‚îÇ  SET status='completed'     ‚îÇ
‚îÇ      completed_at=NOW()     ‚îÇ
‚îÇ      completed_by=$staff_id ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### 4. Archive Generation Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    OWNER     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 1. Select Period (Month/Year)
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Frontend: Fetch data       ‚îÇ
‚îÇ  - activity_logs            ‚îÇ
‚îÇ  - orders (completed)       ‚îÇ
‚îÇ  - presensi_shift           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 2. Generate CSV files
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Generate CSV:              ‚îÇ
‚îÇ  - activity_logs.csv        ‚îÇ
‚îÇ  - sales_data.csv           ‚îÇ
‚îÇ  - staff_attendance.csv     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 3. Upload to Supabase Storage
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  supabase.storage.upload    ‚îÇ
‚îÇ  bucket: 'archives'         ‚îÇ
‚îÇ  path: {year}/{month}/      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 4. Create Archive Record
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  INSERT INTO archives       ‚îÇ
‚îÇ  - archive_id               ‚îÇ
‚îÇ  - period_month/year        ‚îÇ
‚îÇ  - data_types[]             ‚îÇ
‚îÇ  - total_records (JSON)     ‚îÇ
‚îÇ  - key_metrics (JSON)       ‚îÇ
‚îÇ  - csv_files (JSON)         ‚îÇ
‚îÇ  - generated_by             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ ‚úì TRIGGER: trigger_log_archive_activity
       ‚îÇ
       ‚îÇ 5. Log Activity
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  INSERT INTO activity_logs  ‚îÇ
‚îÇ  - action='EXPORT'          ‚îÇ
‚îÇ  - action_category='SYSTEM' ‚îÇ
‚îÇ  - resource_type='archive'  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéì USAGE EXAMPLES FOR AI

### Example 1: "How do I get all pending orders?"

**Query:**
```sql
SELECT 
  order_number,
  customer_name,
  order_type,
  status,
  total,
  created_at
FROM orders
WHERE status IN ('new', 'preparing')
  AND payment_status = 'pending'
ORDER BY created_at ASC;
```

---

### Example 2: "How do I check if a product has enough inventory?"

**Query:**
```sql
-- Get required ingredients for product
SELECT 
  ri.ingredient_name,
  ri.quantity_needed,
  ri.unit,
  ii.current_stock,
  ii.status,
  CASE 
    WHEN ii.current_stock >= ri.quantity_needed THEN true
    ELSE false
  END as has_enough_stock
FROM recipes r
JOIN recipe_ingredients ri ON r.id = ri.recipe_id
JOIN inventory_items ii ON ri.inventory_item_id = ii.id
WHERE r.product_id = $product_id
  AND r.recipe_type = 'base';
```

---

### Example 3: "How do I create an order with variants?"

**Step 1: Insert Order**
```sql
INSERT INTO orders (
  order_number, customer_name, order_type, 
  subtotal, tax, discount, total, 
  payment_status, created_by
) VALUES (
  'ORD001', 'John Doe', 'Dine in',
  50000, 5000, 0, 55000,
  'pending', 'staff_uuid'
) RETURNING id;
```

**Step 2: Insert Order Items with Variants**
```sql
INSERT INTO order_items (
  order_id, product_id, product_name,
  quantity, base_price, variants, total_price
) VALUES (
  'order_uuid',
  'product_uuid',
  'Americano',
  2,
  25000,
  '{"Size": ["Large"], "Milk Type": ["Oat Milk"]}'::jsonb,
  74000
);
```

**Variants JSONB Format:**
```json
{
  "Size": ["Large"],
  "Milk Type": ["Oat Milk"],
  "Sugar Level": ["Less Sugar"]
}
```

---

### Example 4: "How does the hybrid recipe system work?"

**Scenario:** Ordering "Americano Large"

1. **Base Recipe** (recipe_type='base'):
   - 20g coffee beans
   - 200ml water

2. **Global Modifier** (recipe_scope='global-modifier', variant_name='Large'):
   - +50% to all ingredients

3. **Calculation:**
   - Coffee: 20g √ó 1.5 = 30g
   - Water: 200ml √ó 1.5 = 300ml

4. **Product Override** (if exists):
   - Overrides global modifier
   - Uses custom recipe for "Americano Large"
   - Example: 35g coffee, 350ml water

**Priority:** Override > Base + Modifier > Base only

---

### Example 5: "How do I generate staff attendance report?"

```sql
SELECT 
  s.name,
  s.staff_code,
  s.staff_type,
  COUNT(ps.id) as days_attended,
  COUNT(ps.id) FILTER (WHERE ps.status = 'on-time') as days_on_time,
  COUNT(ps.id) FILTER (WHERE ps.status = 'late') as days_late,
  SUM(EXTRACT(EPOCH FROM (ps.check_out - ps.check_in))/3600) as total_hours
FROM staff s
LEFT JOIN presensi_shift ps ON s.id = ps.staff_id
WHERE s.role = 'staff'
  AND DATE(ps.check_in) >= '2024-01-01'
  AND DATE(ps.check_in) <= '2024-01-31'
GROUP BY s.id, s.name, s.staff_code, s.staff_type
ORDER BY days_attended DESC;
```

---

## üìù QUICK TIPS FOR AI CHATBOT

1. **Always check relationships** before suggesting queries
2. **Use proper ENUM values** from the constants section
3. **Consider triggers** - some actions happen automatically
4. **Check CASCADE behaviors** when deleting records
5. **Verify payment_status='paid'** before inventory deduction queries
6. **Use JSONB operators** for variant queries: `->`, `->>`, `@>`, `?`
7. **Remember hybrid recipe priority**: Override > Base+Modifier > Base
8. **Use indexes** mentioned in performance section for optimal queries
9. **Consider soft deletes** (deleted_at) instead of hard deletes for archives
10. **Always join with staff table** to get user names for display

---

## üîö END OF DATABASE AI GUIDE

**Version:** 1.0  
**Last Updated:** December 14, 2025  
**Database:** PostgreSQL/Supabase  
**Project:** Foodies POS System

For questions or updates, refer to:
- `frontend/docs/supabase/` - Raw database exports
- `md/` - Migration history files
- `frontend/lib/types/` - TypeScript type definitions

---

